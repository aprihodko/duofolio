<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <style>
    body {
      margin: 0;
    }

    #reader {
      height: 100vh;
      width: 100vw;
      overflow: hidden !important;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
  <title></title>
</head>
<body>
<div id="reader"></div>
</body>

<script lang="javascript">
  // alert(window.BOOK_PATH)
  window.book = ePub(window.BOOK_PATH);
  window.rendition = window.book.renderTo("reader", { method: "default", width: "100%", height: "100%" });

  if (window.LOCATIONS) {
    window.book.locations.load(window.LOCATIONS);
  } else {
    window.book.ready.then(() => {
      window.book.locations.generate(1650).then(() => {
        window.ReactNativeWebView.postMessage(
          JSON.stringify({ type: 'locations', locations: window.book.locations.save() })
        );
      });
    });
  }

  // Book

  const parseToc = ({ href, label, subitems }) => {
    const topic = label.trim();
    if (subitems.length) {
      return subitems.map(({ href, label }) => {
        return { href, label: `${topic}. ${label.trim()}` };
      })
    } else {
      return { href, label: topic };
    }
  }

  window.book.loaded.navigation.then((nav) => {
    const contents = nav.toc.flatMap(item => parseToc(item));
    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'contents', contents }));
  });

  window.book.loaded.metadata.then((metadata) => {
    window.ReactNativeWebView.postMessage(
      JSON.stringify({
        type: 'metadata',
        title: metadata.title,
        author: metadata.creator
      })
    );
  });

  // window.book.loaded.cover.then((url) => {
  // 	window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'cover', cover: url }));
  // });

  // Rendition

  window.rendition.on('started', () => {
    if (window.BOOK_LOCATION) {
      window.rendition.display(window.BOOK_LOCATION);
    } else {
      window.rendition.display(0);
    }
    window.rendition.themes.register({ theme: window.THEME });
    window.rendition.themes.select('theme');
    window.ReactNativeWebView.postMessage(
      JSON.stringify({ type: 'key', key: window.book.key() })
    );
  });

  window.rendition.on('rendered', () => {
    setTimeout(() => {
      const location = window.rendition.currentLocation();
      const range = window.rendition.getRange(location.start.cfi);
      const endRange = window.rendition.getRange(location.end.cfi);

      range.setEnd(endRange.startContainer, endRange.startOffset);

      const selected = range.toString();
      window.ReactNativeWebView.postMessage(
        JSON.stringify({ type: 'selected', selected })
      );
    }, 500)
  });

  window.rendition.on('relocated', (e) => {
    window.ReactNativeWebView.postMessage(
      JSON.stringify({
        type: 'loc',
        key: window.book.key(),
        cfi: e.start.cfi,
        progress: e.start.location,
        totalPages: window.book.locations.length
      })
    );
  });

  window.rendition.on('selected', () => {
    let selected =
      window.rendition.manager && window.rendition.manager.getContents().length > 0
        ? window.rendition.manager
        .getContents()[0]
        .window.getSelection()
        .toString()
        .trim()
        : '';
    if (selected) {
      window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'selected', selected }));
    }
  });

  // Parse current section paragraphs
  // window.rendition.hooks.content.register((contents, _view) => {
    // setTimeout(() => {
    //   const location = window.rendition.currentLocation();
    //   const section = window.book.spine.get(location.start.cfi);
    //   const elements = contents.document.querySelectorAll('p');
    //   const items = Array.prototype.slice.call(elements);
    //
    //   const paragraphs = items.map((item, index) => {
    //     const cfi = section.cfiFromElement(item);
    //
    //     return {
    //       key: cfi,
    //       text: item.textContent
    //     }
    //   });
    //
    //   window.ReactNativeWebView.postMessage(
    //     JSON.stringify({
    //       type: 'paragraph',
    //       paragraphs
    //     })
    //   );
    // }, 100)
  // })

  // navigator.wakeLock.request('screen').then((wakeLock) => {
  // 	window.wakeLock = wakeLock;
  // });
  // if (window.PAGE_NAV === 'swipe') {
  // 	let touchStart = 0;
  // 	let touchEnd = 0;
  // 	window.rendition.on('touchstart', (e) => {
  // 		touchStart = e.changedTouches[0].screenX;
  // 	});
  // 	window.rendition.on('touchend', (e) => {
  // 		touchEnd = e.changedTouches[0].screenX;
  // 		if (touchStart < touchEnd) {
  // 			window.rendition.prev();
  // 		} else if (touchStart > touchEnd) {
  // 			window.rendition.next();
  // 		}
  // 	});
  // }
</script>
</html>
